<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniAI | Dual Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="importmap">
        { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #0b1120; color: #f8fafc; overflow: hidden; }
        .sidebar { background: #111827; border-right: 1px solid #1e293b; width: 280px; height: 100vh; }
        .view { display: none; height: 100%; flex-direction: column; }
        .view.active { display: flex; }
        .btn-active { background: #312e81; border-left: 4px solid #6366f1; }
    </style>
</head>
<body class="flex h-screen">

    <aside class="sidebar flex flex-col">
        <div class="p-6 text-xl font-bold border-b border-slate-800">OmniAI <span class="text-indigo-400 text-xs">v2.0</span></div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showView('chat')" id="tab-chat" class="w-full flex p-3 rounded-xl hover:bg-slate-800 btn-active"><i class="fas fa-comment mr-3"></i> Chat Console</button>
            <button onclick="showView('studio')" id="tab-studio" class="w-full flex p-3 rounded-xl hover:bg-slate-800"><i class="fas fa-wand-magic-sparkles mr-3"></i> Image Studio</button>
            <div class="pt-6 text-[10px] font-bold text-slate-500 uppercase px-3">History</div>
            <div id="imageHistory" class="space-y-2 px-1"></div>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <button onclick="openSettings()" class="w-full bg-slate-800 p-3 rounded-lg text-sm hover:bg-slate-700">API Keys</button>
        </div>
    </aside>

    <main class="flex-1 relative">
        <section id="chat-view" class="view active">
            <header class="p-4 bg-slate-900/50 flex justify-between px-8 border-b border-slate-800">
                <select id="modelSelect" class="bg-slate-800 border-none rounded-lg px-4 py-2 text-sm text-indigo-300">
                    <optgroup label="Direct Google Engine">
                        <option value="google/gemini-1.5-flash">Gemini 1.5 Flash (Native)</option>
                    </optgroup>
                    <optgroup label="OpenRouter Engine">
                        <option value="openrouter/free">OpenRouter (Free Router)</option>
                        <option value="deepseek/deepseek-chat">DeepSeek V3</option>
                        <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                    </optgroup>
                </select>
                <button onclick="clearChat()" class="text-xs opacity-50 hover:opacity-100">Reset Chat</button>
            </header>
            <div id="chatBox" class="flex-1 overflow-y-auto p-8 space-y-4"></div>
            <div class="p-6 bg-slate-900/30 flex gap-3">
                <input type="text" id="chatInput" placeholder="Ask anything..." class="flex-1 bg-slate-800 p-4 rounded-xl border border-slate-700">
                <button onclick="sendMessage()" class="bg-indigo-600 px-8 rounded-xl"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

        <section id="studio-view" class="view items-center justify-center p-12">
            <div id="output" class="w-full max-w-lg aspect-square bg-slate-900 border-2 border-dashed border-slate-800 rounded-3xl mb-8 flex items-center justify-center overflow-hidden">
                <p class="text-slate-600 italic">Generate images via Gemini Native</p>
            </div>
            <div class="w-full max-w-xl flex gap-3">
                <input type="text" id="imageInput" placeholder="Describe the image..." class="flex-1 bg-slate-800 p-4 rounded-xl border border-slate-700">
                <button onclick="generateImage()" class="bg-indigo-600 px-8 rounded-xl font-bold">Create</button>
            </div>
        </section>
    </main>

    <div id="settings" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 p-4">
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 w-full max-w-md">
            <h2 class="text-xl font-bold mb-6">API Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-slate-500 font-bold uppercase">Google Gemini API Key</label>
                    <input type="password" id="key-google" class="w-full bg-slate-800 p-3 rounded-lg mt-1">
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 font-bold uppercase">OpenRouter API Key</label>
                    <input type="password" id="key-or" class="w-full bg-slate-800 p-3 rounded-lg mt-1">
                </div>
            </div>
            <button onclick="saveKeys()" class="w-full bg-indigo-600 p-4 rounded-xl mt-8 font-bold">Save Keys</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/generative-ai";

        window.showView = (v) => {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(e => e.classList.remove('btn-active'));
            document.getElementById(`${v}-view`).classList.add('active');
            document.getElementById(`tab-${v}`).classList.add('btn-active');
        };

        window.openSettings = () => document.getElementById('settings').style.display = 'flex';
        window.saveKeys = () => {
            localStorage.setItem('key_google', document.getElementById('key-google').value);
            localStorage.setItem('key_or', document.getElementById('key-or').value);
            document.getElementById('settings').style.display = 'none';
        };

        // LOAD KEYS ON START
        document.getElementById('key-google').value = localStorage.getItem('key_google') || '';
        document.getElementById('key-or').value = localStorage.getItem('key_or') || '';

        // ROUTER CHAT HANDLER
        window.sendMessage = async () => {
            const model = document.getElementById('modelSelect').value;
            const text = document.getElementById('chatInput').value;
            if(!text) return;
            
            appendMsg(text, 'user');
            document.getElementById('chatInput').value = '';
            const load = appendMsg("...", 'ai');

            try {
                let reply = "";
                if(model.startsWith('google/')) {
                    const genAI = new GoogleGenAI(localStorage.getItem('key_google'));
                    const aiModel = genAI.getGenerativeModel({ model: model.replace('google/', '') });
                    const res = await aiModel.generateContent(text);
                    reply = res.response.text();
                } else {
                    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${localStorage.getItem('key_or')}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ model: model, messages: [{role:"user", content:text}] })
                    });
                    const data = await res.json();
                    reply = data.choices[0].message.content;
                }
                load.remove();
                appendMsg(reply, 'ai');
            } catch (e) { load.innerHTML = "Error: Check your keys."; }
        };

        // NATIVE GEMINI IMAGE HANDLER
        window.generateImage = async () => {
            const prompt = document.getElementById('imageInput').value;
            const output = document.getElementById('output');
            const key = localStorage.getItem('key_google');
            
            output.innerHTML = `<i class="fas fa-circle-notch animate-spin text-3xl"></i>`;

            try {
                const genAI = new GoogleGenAI(key);
                // Note: Direct Image generation is handled via Modalitiies in 2026 update
                const aiModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const res = await aiModel.generateContent({
                    contents: [{ role: 'user', parts: [{ text: "GENERATE IMAGE: " + prompt }] }],
                    generationConfig: { modalities: ["image"] }
                });
                
                const imgUrl = res.response.candidates[0].content.parts[0].inlineData.data;
                const src = `data:image/png;base64,${imgUrl}`;
                output.innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
                addToHistory(src, prompt);
            } catch (e) { output.innerHTML = "Image generation failed for this key."; }
        };

        function appendMsg(t, s) {
            const d = document.createElement('div');
            d.className = `flex ${s==='user'?'justify-end':'justify-start'} w-full`;
            d.innerHTML = `<div class="${s==='user'?'bg-indigo-600':'bg-slate-800'} p-4 rounded-2xl max-w-[80%]">${marked.parse(t)}</div>`;
            document.getElementById('chatBox').appendChild(d);
            document.getElementById('chatBox').scrollTop = 100000;
            return d;
        }

        function addToHistory(s, p) {
            const h = document.getElementById('imageHistory');
            const d = document.createElement('img');
            d.src = s; d.className = "w-full rounded-lg mb-2 opacity-70 hover:opacity-100 cursor-pointer transition";
            d.onclick = () => { showView('studio'); document.getElementById('output').innerHTML = `<img src="${s}" class="w-full h-full object-cover">`; };
            h.prepend(d);
        }
    </script>
</body>
</html>
